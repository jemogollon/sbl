<html>
<head>
    <script type="text/javascript">
      let productNumber = 2;

      function loadStorefront() {
        localStorage.clear();
        let head = document.getElementsByTagName('head')[0];
        let script = document.createElement('script');
        script.id = 'fsc-api';
        script.type = 'text/javascript';
        script.src = document.getElementById('sblVersion').value;
        script.setAttribute('data-storefront', document.getElementById('storefrontURL').value);
        script.setAttribute('data-access-key', document.getElementById('dataAccessKey').value.trim());
        script.setAttribute('data-continuous', 'true');
        script.setAttribute('data-data-callback', 'dataCallback');
        script.setAttribute('data-error-callback', 'dataErrorCallback');
        head.appendChild(script);
      }

      function dataCallback(payload) {
        document.getElementById('loadStorefront').style.display = 'none';
        document.getElementById('sblVersion').disabled = true;
        document.getElementById('storefrontURL').disabled = true;
        document.getElementById('dataAccessKey').disabled = true;
        document.getElementById('addProduct').style.display = 'inline-block';
        document.getElementById('secureCheckout').style.display = 'inline-block';
        document.getElementById('paymentCheckout').style.display = 'inline-block';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('fsc-embedded-checkout-container').style.display = 'inline-block';
      }

      function dataErrorCallback(errorCode, errorMessage) {
        let message = "couldn't load the storefront, reload the page and try again";

        if (errorMessage != null && errorMessage != undefined && errorMessage.length > 0) {
          message = errorMessage;
        }
        document.getElementById('errorMessage').innerHTML = "Error: " + message;
        document.getElementById('errorMessage').style.display = 'inline-block';
        document.getElementById('fsc-embedded-checkout-container').style.display = 'none';
      }

      function secureCheckout() {
        localStorage.clear();
        fastspring.builder.reset();

        let firstName = document.getElementById("fname").value;
        let lastName = document.getElementById("lname").value;
        let emailAddress = document.getElementById("email").value;
        let product = document.getElementById("product1").value;
        let paymentMethod = document.getElementById("paymentMethod").value;
        let hidePaymentMethods = document.getElementById("hidePaymentMethods").checked;
        let country = document.getElementById("country").value;
        let postalCode = document.getElementById('postalCode').value;
        let tags = document.getElementById('tags').value;
        let paymentMethodOrder = document.getElementById('paymentMethodOrder').value;

        let payload = {
          "contact": {
            "firstName": firstName,
            "lastName": lastName,
            "email": emailAddress,
            "country": country,
            "postalCode": postalCode
          },
          "tags": tags,
          "language": "EN",
          "items": getProductsArray(),
          "paymentMethod": paymentMethod,
          "hideOtherPaymentMethods": hidePaymentMethods,
          "hidePaymentMethods": getHiddenPaymentMethodsArray(),
          "paymentMethodOrder": paymentMethodOrder ? paymentMethodOrder.trim().split(',') : null
        };

        fetch('https://qa-validator-api.fastspring.com/address/encrypt',  {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload),
        }).then(response => response.json())
          .then(json => {
            console.log(json);
            fastspring.builder.secure(json.response.securePayload, json.response.secureKey);
            fastspring.builder.checkout();
            fastspring.builder.update(product, 1);
          })
          .catch(err => console.log(err));
      }

      function insecureCheckout() {
        localStorage.clear();
        fastspring.builder.reset();
        let products = document.getElementsByClassName('product');

        for (let i = 0; i < products.length; ++i) {
          fastspring.builder.add(products[i].value);
        }

        fastspring.builder.recognize({
          "firstName": document.getElementById("fname").value,
          "lastName": document.getElementById("lname").value,
          "email": document.getElementById("email").value,
          "country": document.getElementById("country").value,
          "postalCode": document.getElementById('postalCode').value
        });
        fastspring.builder.payment(document.getElementById("paymentMethod").value, document.getElementById("hidePaymentMethods").checked);
      }

      function addProduct() {
        let productContainer = document.getElementById('product-container');
        let productLabel = document.createElement('label');
        productLabel.setAttribute('for', 'product' + productNumber);
        productLabel.innerHTML = 'Product ' + productNumber + ': ';
        productContainer.appendChild(productLabel);

        let productInput = document.createElement('input');
        productInput.id = 'product' + productNumber;
        productInput.name = 'product' + productNumber;
        productInput.className = 'product';
        productContainer.appendChild(productInput);

        let priceInput = document.createElement('input');
        priceInput.id = 'price' + productNumber;
        priceInput.name = 'price' + productNumber;
        priceInput.className = 'price';
        priceInput.style = "width: 125px; margin-left: 5px;";
        priceInput.type = "number";
        priceInput.placeholder = "price (optional)";
        productContainer.appendChild(priceInput);

        productContainer.appendChild(document.createElement('br'));
        productContainer.appendChild(document.createElement('br'));
        productNumber++;
      }

      function getProductsArray() {
        let products = document.getElementsByClassName('product');
        let prices = document.getElementsByClassName('price');
        let productsArray = [];

        for (let i = 0; i < products.length; ++i) {
          productsArray[i] = {"product": products[i].value};
          if (prices[i].value) {
            productsArray[i].pricing = {"price": {"USD": prices[i].value}};
          }
        }
        return productsArray;
      }

      function getHiddenPaymentMethodsArray() {
        let hiddenPaymentMethods = document.getElementsByName('hidden-options');
        let hiddenOptionsArray = [];

        hiddenPaymentMethods.forEach(hiddenPaymentMethod => {
          if (hiddenPaymentMethod.checked) {
            hiddenOptionsArray.push(hiddenPaymentMethod.value)
          }
        });
        return hiddenOptionsArray;
      }
    </script>
</head>
<body>
<div class="column" style="background-color: whiteSmoke; padding:20px; border-radius: 25px;float:left;">
    <form>
        <label id="sbl-version-label" for="sblVersion">SBL Version:</label>
        <input type="text" id="sblVersion" name="sblVersion" style="width:540px;" value="https://d1f8f9xcsvx3ha.cloudfront.net/sbl/1.0.5/fastspring-builder.min.js"><br><br>

        <label id="storefront-url-label" for="storefrontURL">Storefront URL:</label>
        <input type="text" id="storefrontURL" name="storefrontURL" style="width:460px;"><br><br>

        <label id="data-access-key-label" for="dataAccessKey">Data access key:</label>
        <input type="text" id="dataAccessKey" name="dataAccessKey" style="width:240px;" ><br><br><hr><br>

        <label for="fname">First name:</label>
        <input type="text" id="fname" name="fname" value="John"><br><br>

        <label for="lname">Last name:</label>
        <input type="text" id="lname" name="lname" value="Doe"><br><br>

        <label for="email">Email:</label>
        <input type="text" id="email" name="email" style="width:340px;" value="@fastspring.com"><br><br>

        <div id="product-container">
            <label for="product1">Product:</label>
            <input type="text" id="product1" name="product1" class="product">
            <input type="number" id="price1" placeholder="price (optional)" name="price1" class="price" style="width: 125px; margin-left: 5px;"><br><br>
        </div>

        <label for="paymentMethod">Payment Method:</label>
        <select name="paymentMethod" id="paymentMethod">
            <option value=""></option>
            <option value="card">card</option>
            <option value="wire">wire</option>
            <option value="purchaseorder">invoice</option>
            <option value="paypal">paypal</option>
            <option value="amazon">amazon</option>
            <option value="ach">ach</option>
            <option value="ideal">ideal</option>
            <option value="test">test</option>
            <option value="free">free</option>
            <option value="applepay">applepay</option>
            <option value="alipay">alipay</option>
            <option value="sepa">sepa</option>
            <option value="sofort">sofort</option>
            <option value="giropay">giropay</option>
            <option value="googlepay">googlepay</option>
            <option value="pix">pix</option>
            <option value="kakaopay">kakaopay</option>
            <option value="wechatpay">wechatpay</option>
            <option value="klarna">klarna</option>
            <option value="upi">upi</option>
            <option value="toss">toss</option>
        </select><br><br>

        <label for="hidePaymentMethods">Hide other payment methods:</label>
        <input type="checkbox" id="hidePaymentMethods" name="hidePaymentMethods"><br><br>

        <label for="country">Country:</label>
        <input type="text" id="country" name="country" style="width:40px;" value="US"><br><br>

        <label for="postalCode">Postal Code:</label>
        <input type="text" id="postalCode" name="postalCode" style="width:80px;"><br><br>

        <label for="tags">Tags:</label>
        <input type="text" id="tags" name="tags" style="width:340px;"><br><br>
        
        <label for="paymentMethodOrder">Payment Method Order:</label>
        <input type="text" id="paymentMethodOrder" name="paymentMethodOrder" style="width:340px;"><br><br>

        <label for="hide-payment-methods">Hide Payment Methods:</label>
        <div id="hide-payment-methods">
            <input type="checkbox" id="card-hidden" name="hidden-options" value="card">
            <label for="card-hidden">card</label>

            <input type="checkbox" id="wire-hidden" name="hidden-options" value="wire">
            <label for="wire-hidden">wire</label>

            <input type="checkbox" id="purchaseorder-hidden" name="hidden-options" value="purchaseorder">
            <label for="purchaseorder-hidden">purchaseorder</label>

            <input type="checkbox" id="paypal-hidden" name="hidden-options" value="paypal">
            <label for="paypal-hidden">paypal</label>

            <input type="checkbox" id="amazon-hidden" name="hidden-options" value="amazon">
            <label for="amazon-hidden">amazon</label>

            <input type="checkbox" id="ach-hidden" name="hidden-options" value="ach">
            <label for="ach-hidden">ach</label>

            <input type="checkbox" id="ideal-hidden" name="hidden-options" value="ideal">
            <label for="ideal-hidden">ideal</label>

            <input type="checkbox" id="applepay-hidden" name="hidden-options" value="applepay">
            <label for="applepay-hidden">applepay</label>

            <input type="checkbox" id="alipay-hidden" name="hidden-options" value="alipay">
            <label for="alipay-hidden">alipay</label>

            <input type="checkbox" id="sepa-hidden" name="hidden-options" value="sepa">
            <label for="sepa-hidden">sepa</label><br><br>

            <input type="checkbox" id="sofort-hidden" name="hidden-options" value="sofort">
            <label for="sofort-hidden">sofort</label>

            <input type="checkbox" id="giropay-hidden" name="hidden-options" value="giropay">
            <label for="giropay-hidden">giropay</label>

            <input type="checkbox" id="googlepay-hidden" name="hidden-options" value="googlepay">
            <label for="googlepay-hidden">googlepay</label>

            <input type="checkbox" id="pix-hidden" name="hidden-options" value="pix">
            <label for="pix-hidden">pix</label>

            <input type="checkbox" id="kakaopay-hidden" name="hidden-options" value="kakaopay">
            <label for="kakaopay-hidden">kakaopay</label>

            <input type="checkbox" id="wechatpay-hidden" name="hidden-options" value="wechatpay">
            <label for="wechatpay-hidden">wechatpay</label>

            <input type="checkbox" id="klarna-hidden" name="hidden-options" value="klarna">
            <label for="klarna-hidden">klarna</label>

            <input type="checkbox" id="upi-hidden" name="hidden-options" value="upi">
            <label for="upi-hidden">upi</label>
            
            <input type="checkbox" id="toss-hidden" name="hidden-options" value="toss">
            <label for="toss-hidden">toss</label>
        </div>
    </form>
    <button id="loadStorefront" onclick="loadStorefront()">Load Storefront</button>
    <button id="addProduct" onclick="addProduct()" style="display: none;">Add another product</button>
    <button id="secureCheckout" onclick="secureCheckout()" style="display:none;">Secure Checkout</button>
    <button id="paymentCheckout" onclick="insecureCheckout()" style="display:none; margin-left: 8px;">Insecure checkout</button><br>

    <p id="errorMessage" style="color: red;margin-top:30px;font-size:17px;display:none;"></p>
</div>
<div id="fsc-embedded-checkout-container" style="width:900px;margin-left:60px; float:left;">
</div>

</body>
</html>
